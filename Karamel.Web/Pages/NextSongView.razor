@page "/nextsong"
@using Fluxor
@using Fluxor.Blazor.Web.Components
@using Karamel.Web.Models
@using Karamel.Web.Store.Playlist
@using Karamel.Web.Store.Session
@using Microsoft.JSInterop

@inherits FluxorComponent
@implements IAsyncDisposable

@inject IState<SessionState> SessionState
@inject IState<PlaylistState> PlaylistState
@inject IDispatcher Dispatcher
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<PageTitle>Next Song - Karamel Karaoke</PageTitle>

<div class="nextsong-view">
    @if (SessionState.Value.CurrentSession == null)
    {
        <div class="alert alert-danger m-4" role="alert">
            <h4 class="alert-heading">Invalid Session</h4>
            <p>No active karaoke session found. Please start a new session from the home page.</p>
        </div>
    }
    else
    {
        @if (PlaylistState.Value.Queue.Count > 0)
        {
            <div class="nextsong-container">
                <div class="nextsong-content">
                    <h1 class="artist-name">@nextSong?.Artist</h1>
                    <h2 class="song-title">@nextSong?.Title</h2>
                    @if (!string.IsNullOrWhiteSpace(nextSong?.AddedBySinger))
                    {
                        <p class="singer-name">Requested by: @nextSong.AddedBySinger</p>
                    }
                </div>

                <div class="qrcode-section">
                    <div class="qrcode-content">
                        <p class="qrcode-label">Sing a song</p>
                        <div id="qrcode-container" class="qrcode-small"></div>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="empty-queue-container">
                <div class="empty-queue-content">
                    <div class="microphone-icon">
                        <i class="bi bi-mic-fill"></i>
                    </div>
                    <h1 class="empty-queue-title">Sing a song!</h1>
                    <p class="empty-queue-subtitle">Scan the QR code to add songs to the queue</p>
                    <div id="qrcode-container" class="qrcode-large"></div>
                </div>
            </div>
        }
    }
</div>

@code {
    private IJSObjectReference? qrcodeModule;
    private Song? nextSong;
    private Timer? autoAdvanceTimer;
    private bool isDisposed = false;
    private Queue<Song>? previousQueue;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        // Initialize next song
        UpdateNextSong();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);

        if (firstRender && SessionState.Value.CurrentSession != null)
        {
            // Load QR code module
            qrcodeModule = await JSRuntime.InvokeAsync<IJSObjectReference>(
                "import", "./js/qrcode.js");

            // Generate session URL for QR code
            var sessionUrl = GenerateSessionUrl();
            
            // Generate QR code
            await qrcodeModule.InvokeVoidAsync("generateQRCode", "qrcode-container", sessionUrl);

            // Start auto-advance timer if queue has songs
            StartAutoAdvanceTimer();
        }
        else if (!firstRender)
        {
            // Check if playlist changed
            var currentQueue = PlaylistState.Value.Queue;
            if (previousQueue != currentQueue)
            {
                // Update next song when playlist changes
                var previousNextSong = nextSong;
                UpdateNextSong();

                // Restart timer if song changed
                if (previousNextSong?.Id != nextSong?.Id)
                {
                    StartAutoAdvanceTimer();
                }

                previousQueue = currentQueue;
            }
        }
    }

    private void UpdateNextSong()
    {
        nextSong = PlaylistState.Value.Queue.Count > 0 
            ? PlaylistState.Value.Queue.FirstOrDefault() 
            : null;
    }

    private void StartAutoAdvanceTimer()
    {
        // Cancel existing timer
        autoAdvanceTimer?.Dispose();
        autoAdvanceTimer = null;

        // Only start timer if queue has songs and pause is enabled
        if (PlaylistState.Value.Queue.Count > 0 && 
            SessionState.Value.CurrentSession?.PauseBetweenSongs == true)
        {
            var pauseSeconds = SessionState.Value.CurrentSession.PauseBetweenSongsSeconds;
            
            autoAdvanceTimer = new Timer(_ =>
            {
                if (!isDisposed)
                {
                    NavigateToPlayer();
                }
            }, null, TimeSpan.FromSeconds(pauseSeconds), Timeout.InfiniteTimeSpan);
        }
    }

    private void NavigateToPlayer()
    {
        if (SessionState.Value.CurrentSession != null)
        {
            var sessionId = SessionState.Value.CurrentSession.SessionId;
            NavigationManager.NavigateTo($"/player?session={sessionId}");
        }
    }

    private string GenerateSessionUrl()
    {
        if (SessionState.Value.CurrentSession == null)
        {
            return string.Empty;
        }

        var sessionId = SessionState.Value.CurrentSession.SessionId;
        var baseUrl = NavigationManager.BaseUri.TrimEnd('/');
        return $"{baseUrl}/singer?session={sessionId}";
    }

    public new async ValueTask DisposeAsync()
    {
        isDisposed = true;

        // Dispose timer
        autoAdvanceTimer?.Dispose();
        autoAdvanceTimer = null;

        // Dispose JS module
        if (qrcodeModule != null)
        {
            await qrcodeModule.DisposeAsync();
        }
    }
}
