@page "/nextsong"
@using Fluxor
@using Fluxor.Blazor.Web.Components
@using Karamel.Web.Models
@using Karamel.Web.Store.Playlist
@using Karamel.Web.Store.Session
@using Microsoft.JSInterop
@using Karamel.Web.Services

@inherits FluxorComponent
@implements IAsyncDisposable

@inject IState<SessionState> SessionState
@inject IState<PlaylistState> PlaylistState
@inject IDispatcher Dispatcher
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject IServiceProvider ServiceProvider

<PageTitle>Next Song - Karamel Karaoke</PageTitle>

<div class="nextsong-view">
    @if (!isSessionValid)
    {
        <div class="alert alert-danger m-4" role="alert">
            <h4 class="alert-heading">Invalid Session</h4>
            <p>No active karaoke session found. Please start a new session from the home page.</p>
        </div>
    }
    else
    {
        @if (PlaylistState.Value.Queue.Count > 0)
        {
            <div class="nextsong-container">
                <div class="nextsong-content">
                    <h1 class="artist-name">@nextSong?.Artist</h1>
                    <h2 class="song-title">@nextSong?.Title</h2>
                    @if (!string.IsNullOrWhiteSpace(nextSong?.AddedBySinger))
                    {
                        <p class="singer-name">Requested by: @nextSong.AddedBySinger</p>
                    }
                </div>

                <div class="qrcode-section">
                    <div class="qrcode-content">
                        <p class="qrcode-label">Sing a song</p>
                        @if (isLocalhost)
                        {
                            <a href="@GenerateSessionUrl()" target="_blank" class="session-link">
                                Open Singer View
                            </a>
                        }
                        else
                        {
                            <div id="qrcode-container" class="qrcode-small"></div>
                        }
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="empty-queue-container">
                <div class="empty-queue-content">
                    <div class="microphone-icon">
                        <i class="bi bi-mic-fill"></i>
                    </div>
                    <h1 class="empty-queue-title">Sing a song!</h1>
                    @if (isLocalhost)
                    {
                        <p class="empty-queue-subtitle">Click the link below to add songs to the queue</p>
                        <div class="qrcode-large">
                            <a href="@GenerateSessionUrl()" target="_blank" class="session-link-large">
                                Open Singer View
                            </a>
                        </div>
                    }
                    else
                    {
                        <p class="empty-queue-subtitle">Scan the QR code to add songs to the queue</p>
                        <div id="qrcode-container" class="qrcode-large"></div>
                    }
                </div>
            </div>
        }
    }
</div>

@code {
    [Parameter]
    [SupplyParameterFromQuery(Name = "session")]
    public string? SessionParam { get; set; }

    private IJSObjectReference? qrcodeModule;
    private Song? nextSong;
    private Timer? autoAdvanceTimer;
    private bool isDisposed = false;
    private Queue<Song>? previousQueue;
    private bool isSessionValid = false;
    private bool isLocalhost = false;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        // Check if running on localhost
        isLocalhost = IsLocalhostEnvironment();

        // Validate session parameter
        isSessionValid = ValidateSession();

        // Subscribe to playlist updates so we react immediately when queue changes
        Console.WriteLine($"NextSongView: Subscribing to PlaylistState changes. Current queue count={PlaylistState.Value.Queue?.Count ?? 0}");
        PlaylistState.StateChanged += OnPlaylistStateChanged;

        // Subscribe to session state changes so we can initialize when session data arrives
        SessionState.StateChanged += OnSessionStateChanged;

        if (isSessionValid)
        {
            // Initialize next song
            UpdateNextSong();
        }
    }

    private async void OnSessionStateChanged(object? sender, EventArgs e)
    {
        try
        {
            if (!isSessionValid && ValidateSession())
            {
                isSessionValid = true;
                // If session becomes valid later, initialize main-tab responsibilities
                await InitializeMainTabAsync();
                UpdateNextSong();
                StartAutoAdvanceTimer();
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"NextSongView: Error handling session state change: {ex.Message}");
        }
    }

    private void OnPlaylistStateChanged(object? sender, EventArgs e)
    {
        try
        {
            Console.WriteLine($"NextSongView: OnPlaylistStateChanged invoked. QueueCount={PlaylistState.Value.Queue?.Count ?? 0}");
            UpdateNextSong();
            StartAutoAdvanceTimer();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"NextSongView: Error handling playlist state change: {ex.Message}");
        }

        InvokeAsync(StateHasChanged);
    }

    private bool IsLocalhostEnvironment()
    {
        var uri = new Uri(NavigationManager.Uri);
        var host = uri.Host.ToLowerInvariant();
        return host == "localhost" || host == "127.0.0.1" || host == "::1";
    }

    private bool ValidateSession()
    {
        // If no session in state, it's invalid
        if (SessionState.Value.CurrentSession == null)
        {
            return false;
        }

        // STRICT VALIDATION: Session parameter is REQUIRED for multi-session support
        if (string.IsNullOrWhiteSpace(SessionParam) || !Guid.TryParse(SessionParam, out var sessionGuid))
        {
            return false;
        }

        // Session ID must match the parameter
        return SessionState.Value.CurrentSession.SessionId == sessionGuid;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);

        Console.WriteLine($"NextSongView: OnAfterRenderAsync firstRender={firstRender}. isSessionValid={isSessionValid}. QueueCount={PlaylistState.Value.Queue?.Count ?? 0}");
        if (firstRender && isSessionValid && !isLocalhost)
        {
            await InitializeMainTabAsync();
        }
        else if (firstRender && isSessionValid && isLocalhost)
        {
            await InitializeMainTabAsync();
        }
        else if (!firstRender && isSessionValid)
        {
            // Check if playlist changed
            var currentQueue = PlaylistState.Value.Queue;
            if (previousQueue != currentQueue)
            {
                // Update next song when playlist changes
                var previousNextSong = nextSong;
                UpdateNextSong();

                    Console.WriteLine($"NextSongView: Playlist changed in OnAfterRender. previousNextId={previousNextSong?.Id} newNextId={nextSong?.Id}");

                // Restart timer if song changed
                if (previousNextSong?.Id != nextSong?.Id)
                {
                    StartAutoAdvanceTimer();
                }

                previousQueue = currentQueue;
            }
        }
    }

    private async Task InitializeMainTabAsync()
    {
        try
        {
            var sessionId = SessionState.Value.CurrentSession?.SessionId;
            var sessionService = ServiceProvider.GetService(typeof(Karamel.Web.Services.ISessionService)) as Karamel.Web.Services.ISessionService;
            if (sessionId != null && sessionService != null)
            {
                await sessionService.InitializeAsync(sessionId.Value, true);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"NextSongView: Failed to initialize SessionService as main tab: {ex.Message}");
        }

        // Load QR code module only if not on localhost
        try
        {
            if (!isLocalhost)
            {
                qrcodeModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./js/qrcode.js");
                var sessionUrl = GenerateSessionUrl();
                await qrcodeModule.InvokeVoidAsync("generateQRCode", "qrcode-container", sessionUrl);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"NextSongView: Failed to initialize QR code module: {ex.Message}");
        }

        // Start timer if appropriate
        StartAutoAdvanceTimer();
    }

    private void UpdateNextSong()
    {
        nextSong = PlaylistState.Value.Queue.Count > 0 
            ? PlaylistState.Value.Queue.FirstOrDefault() 
            : null;
    }

    private void StartAutoAdvanceTimer()
    {
        // Cancel existing timer
        autoAdvanceTimer?.Dispose();
        autoAdvanceTimer = null;

        // Only start timer if queue has songs and pause is enabled
        if (PlaylistState.Value.Queue.Count > 0 && 
            SessionState.Value.CurrentSession?.PauseBetweenSongs == true)
        {
            var pauseSeconds = SessionState.Value.CurrentSession.PauseBetweenSongsSeconds;
            
            autoAdvanceTimer = new Timer(_ =>
            {
                if (!isDisposed)
                {
                    NavigateToPlayer();
                }
            }, null, TimeSpan.FromSeconds(pauseSeconds), Timeout.InfiniteTimeSpan);
        }
    }

    private void NavigateToPlayer()
    {
        if (SessionState.Value.CurrentSession != null)
        {
            var sessionId = SessionState.Value.CurrentSession.SessionId;

            // Ensure the player will receive the next song as CurrentSong
            try
            {
                Dispatcher.Dispatch(new NextSongAction());
            }
            catch (Exception ex)
            {
                Console.WriteLine($"NextSongView: Error dispatching NextSongAction: {ex.Message}");
            }

            NavigationManager.NavigateTo($"/player?session={sessionId}");
        }
    }

    private string GenerateSessionUrl()
    {
        if (SessionState.Value.CurrentSession == null)
        {
            return string.Empty;
        }

        var sessionId = SessionState.Value.CurrentSession.SessionId;
        var baseUrl = NavigationManager.BaseUri.TrimEnd('/');
        return $"{baseUrl}/singer?session={sessionId}";
    }

    protected override async ValueTask DisposeAsyncCore(bool disposing)
    {
        if (disposing)
        {
            isDisposed = true;

            // Dispose timer
            autoAdvanceTimer?.Dispose();
            autoAdvanceTimer = null;

            // Unsubscribe from playlist state changes
            try
            {
                PlaylistState.StateChanged -= OnPlaylistStateChanged;
            }
            catch { }

            // Dispose JS module
            if (qrcodeModule != null)
            {
                await qrcodeModule.DisposeAsync();
            }
        }

        // Call base to dispose Fluxor subscriptions
        await base.DisposeAsyncCore(disposing);
    }
}
