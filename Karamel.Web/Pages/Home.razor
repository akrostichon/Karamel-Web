@page "/"
@using Fluxor
@using Karamel.Web.Models
@using Karamel.Web.Store.Session
@using Karamel.Web.Store.Library
@using Microsoft.JSInterop
@implements IAsyncDisposable
@inject IJSRuntime JSRuntime
@inject IDispatcher Dispatcher
@inject NavigationManager NavigationManager

<PageTitle>Karamel - Karaoke Session Setup</PageTitle>

<div class="container-fluid vh-100 d-flex align-items-center justify-content-center">
    <div class="card shadow-lg" style="max-width: 600px; width: 100%;">
        <div class="card-header card-header-title">
            <h1 class="h3 mb-0">Karaoke Session Setup</h1>
        </div>
        <div class="card-body">
            @if (!_isFileSystemAccessSupported)
            {
                <div class="alert alert-danger" role="alert">
                    <strong>Browser Not Supported</strong>
                    <p class="mb-0">This application requires the File System Access API, which is only available in Chrome, Edge, and Opera browsers.</p>
                </div>
            }
            else
            {
                <div class="mb-4">
                    <h5 class="mb-3">1. Select Karaoke Library</h5>
                        <button class="btn k-btn-outline btn-lg w-100 select-library" 
                            @onclick="SelectLibrary" 
                            disabled="@_isSelectingLibrary">
                        @if (_isSelectingLibrary)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            <span>Scanning library...</span>
                        }
                        else if (_librarySelected)
                        {
                            <span>✓ Library Selected (@_songCount songs)</span>
                        }
                        else
                        {
                            <span>📁 Select Library Folder</span>
                        }
                    </button>
                    @if (!string.IsNullOrEmpty(_libraryError))
                    {
                        <div class="alert alert-danger mt-2 mb-0" role="alert">
                            @_libraryError
                        </div>
                    }
                </div>

                <div class="mb-4">
                    <h5 class="mb-3">2. Configure Settings</h5>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="requireSingerName" 
                               @bind="_requireSingerName">
                        <label class="form-check-label" for="requireSingerName">
                            Require singer name
                        </label>
                        <small class="form-text d-block muted-on-surface">Singers must enter their name before adding songs</small>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="allowSingerReorder" 
                               @bind="_allowSingerReorder">
                        <label class="form-check-label" for="allowSingerReorder">
                            Allow singers to reorder playlist
                        </label>
                        <small class="form-text d-block muted-on-surface">Let singers rearrange the queue order</small>
                    </div>

                    <div class="mb-3">
                        <label for="pauseBetweenSongs" class="form-label">Pause between songs (seconds)</label>
                        <input type="number" class="form-control" id="pauseBetweenSongs" 
                               @bind="_pauseBetweenSongs" 
                               min="0" max="60" step="1">
                        <small class="form-text muted-on-surface">Time to display "Next Song" screen (0-60 seconds)</small>
                    </div>

                    <div class="mb-3">
                        <label for="filenamePattern" class="form-label">Filename parsing pattern</label>
                        <input type="text" class="form-control" id="filenamePattern" 
                               @bind="_filenamePattern" 
                               placeholder="%artist - %title">
                        <small class="form-text muted-on-surface">Use %artist and %title placeholders to parse filenames</small>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="mb-3">
                        <label class="form-label">Theme</label>
                        <div class="d-flex gap-2">
                            <button class='btn @(_themeChoice == "light" ? "k-btn-primary" : "k-btn-outline-secondary")' @onclick="SetLightTheme" disabled="@_themeLocked">Light</button>
                            <button class='btn @(_themeChoice == "dark" ? "k-btn-primary" : "k-btn-outline-secondary")' @onclick="SetDarkTheme" disabled="@_themeLocked">Dark</button>
                        </div>
                        <small class="form-text d-block muted-on-surface">Choose a theme now. Once the session is started this choice is locked for all participants.</small>
                    </div>

                    <h5 class="mb-3">3. Start Session</h5>
                        <button class="btn k-btn-success btn-lg w-100 start-session" 
                            @onclick="StartSession" 
                            disabled="@(!CanStartSession)">
                        @if (_isStartingSession)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            <span>Starting session...</span>
                        }
                        else
                        {
                            <span>🎤 Start Karaoke Session</span>
                        }
                    </button>
                    @if (!string.IsNullOrEmpty(_startSessionError))
                    {
                        <div class="alert alert-danger mt-2 mb-0" role="alert">
                            @_startSessionError
                        </div>
                    }
                </div>
            }
        </div>
        <div class="card-footer text-center muted-on-surface">
            <small>Karamel Karaoke System v1.0</small>
        </div>
    </div>
</div>

@code {
    private IJSObjectReference? _homeInteropModule;
    private IJSObjectReference? _themeModule;
    private bool _isFileSystemAccessSupported = true;
    private bool _themeLocked = false;
    private string? _themeChoice = null;
    private bool _isSelectingLibrary = false;
    private bool _librarySelected = false;
    private bool _isStartingSession = false;
    private string? _libraryError;
    private string? _startSessionError;
    private int _songCount = 0;
    private List<Song>? _selectedSongs;

    // Configuration settings
    private bool _requireSingerName = true;
    private bool _allowSingerReorder = false;
    private int _pauseBetweenSongs = 10;
    private string _filenamePattern = "%artist - %title";

    private bool CanStartSession => _librarySelected && !_isStartingSession && !_isSelectingLibrary;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                _homeInteropModule = await JSRuntime.InvokeAsync<IJSObjectReference>(
                    "import", "./js/homeInterop.js");

                _isFileSystemAccessSupported = await _homeInteropModule.InvokeAsync<bool>(
                    "isFileSystemAccessSupported");

                // Import theme module so we can call setTheme/getTheme without eval
                try
                {
                    _themeModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./js/themeToggle.js");
                    // Initialize theme preference from persisted storage or system preference
                    try
                    {
                        var initResult = await _themeModule.InvokeAsync<string>("initTheme");
                        if (!string.IsNullOrEmpty(initResult))
                        {
                            _themeChoice = initResult;
                        }
                        else
                        {
                            // Fallback to prefers-color-scheme if no explicit preference
                            var prefersDark = await JSRuntime.InvokeAsync<bool>("eval", "window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches");
                            _themeChoice = prefersDark ? "dark" : "light";
                        }
                    }
                    catch
                    {
                        // ignore get/init failures
                    }
                }
                catch
                {
                    // ignore module load errors
                }

                StateHasChanged();
            }
            catch (Exception ex)
            {
                Console.Error.WriteLine($"Failed to load homeInterop module: {ex.Message}");
                _isFileSystemAccessSupported = false;
                StateHasChanged();
            }
        }
    }

    private async Task SelectLibrary()
    {
        if (_homeInteropModule == null)
            return;

        _isSelectingLibrary = true;
        _libraryError = null;
        StateHasChanged();

        try
        {
            var result = await _homeInteropModule.InvokeAsync<LibrarySelectionResult>(
                "selectLibrary", _filenamePattern);

            if (result == null)
            {
                // User cancelled
                _libraryError = null;
            }
            else if (result.Success)
            {
                _librarySelected = true;
                _songCount = result.SongCount;
                _selectedSongs = result.Songs;
                _libraryError = null;

                // Dispatch action to load library into state
                Dispatcher.Dispatch(new LoadLibraryAction(result.Songs));
            }
            else
            {
                _libraryError = $"Error loading library: {result.Error}";
            }
        }
        catch (Exception ex)
        {
            _libraryError = $"Failed to select library: {ex.Message}";
        }
        finally
        {
            _isSelectingLibrary = false;
            StateHasChanged();
        }
    }

    private async Task SetThemeAsync(string theme)
    {
        try
        {
            _themeChoice = theme;
            // Apply immediately in the host tab and persist via themeToggle module
            if (_themeModule != null)
            {
                await _themeModule.InvokeVoidAsync("setTheme", theme);
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("eval", $"window.themeToggle && window.themeToggle.setTheme('{theme}')");
            }
            StateHasChanged();
        }
        catch
        {
            // ignore
        }
    }

    private Task SetLightTheme() => SetThemeAsync("light");
    private Task SetDarkTheme() => SetThemeAsync("dark");

    private async Task StartSession()
    {
        if (_homeInteropModule == null || _selectedSongs == null)
            return;

        _isStartingSession = true;
        _startSessionError = null;
        StateHasChanged();

        try
        {
            // Create session ID
            var sessionId = await _homeInteropModule.InvokeAsync<string>("generateSessionId");

            // Read current theme from themeToggle (if present)
            string? currentTheme = null;
            try
            {
                currentTheme = await JSRuntime.InvokeAsync<string>("eval", "window.themeToggle && window.themeToggle.getTheme ? window.themeToggle.getTheme() : null");
            }
            catch
            {
                // ignore
            }

            // Create session configuration
            var config = new SessionConfig
            {
                SessionId = sessionId,
                RequireSingerName = _requireSingerName,
                AllowSingerReorder = _allowSingerReorder,
                PauseBetweenSongs = _pauseBetweenSongs,
                FilenamePattern = _filenamePattern,
                Theme = currentTheme ?? _themeChoice
            };

            // Validate configuration
            var validation = await _homeInteropModule.InvokeAsync<ValidationResult>(
                "validateConfiguration", config);

            if (!validation.IsValid)
            {
                _startSessionError = $"Invalid configuration: {string.Join(", ", validation.Errors)}";
                _isStartingSession = false;
                StateHasChanged();
                return;
            }

            // Initialize session in state
            var session = new Models.Session
            {
                SessionId = Guid.Parse(sessionId),
                LibraryPath = "Selected Library", // We don't have actual path from File System Access API
                RequireSingerName = _requireSingerName,
                PauseBetweenSongs = true, // Always enable pause screen between songs
                PauseBetweenSongsSeconds = _pauseBetweenSongs,
                FilenamePattern = _filenamePattern
            };

            Dispatcher.Dispatch(new InitializeSessionAction(session));

            // Lock theme for this session so other tabs cannot change it
            _themeLocked = true;
            StateHasChanged();

            // Start karaoke session (opens tabs and returns navigation URL)
            var result = await _homeInteropModule.InvokeAsync<SessionStartResult>(
                "startKaraokeSession", config, _selectedSongs);

            // Navigate current tab to NextSongView
            NavigationManager.NavigateTo(result.NextSongUrl, false);
        }
        catch (Exception ex)
        {
            _startSessionError = $"Failed to start session: {ex.Message}";
            _isStartingSession = false;
            StateHasChanged();
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_homeInteropModule != null)
        {
            await _homeInteropModule.DisposeAsync();
        }
        if (_themeModule != null)
        {
            await _themeModule.DisposeAsync();
        }
    }

    // DTOs for JS interop
    private class LibrarySelectionResult
    {
        public List<Song> Songs { get; set; } = new();
        public int SongCount { get; set; }
        public bool Success { get; set; }
        public string? Error { get; set; }
    }

    private class SessionConfig
    {
        public string SessionId { get; set; } = string.Empty;
        public bool RequireSingerName { get; set; }
        public bool AllowSingerReorder { get; set; }
        public int PauseBetweenSongs { get; set; }
        public string FilenamePattern { get; set; } = string.Empty;
        public string? Theme { get; set; }
    }

    private class ValidationResult
    {
        public bool IsValid { get; set; }
        public List<string> Errors { get; set; } = new();
    }

    private class SessionStartResult
    {
        public string SessionId { get; set; } = string.Empty;
        public string NextSongUrl { get; set; } = string.Empty;
        public string PlaylistUrl { get; set; } = string.Empty;
        public string SingerUrl { get; set; } = string.Empty;
    }
}
