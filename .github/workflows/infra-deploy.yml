name: Infra Deploy (Bicep)

on:
  workflow_dispatch:
    inputs:
      rg:
        description: 'Resource group to deploy into'
        required: true
        default: 'rg-karamel-prod'
      namePrefix:
        description: 'Resource name prefix'
        required: true
        default: 'rg-karamel-prod'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Bicep
        run: |
          az deployment group create \
            --resource-group ${{ github.event.inputs.rg }} \
            --template-file infra/azure/main.bicep \
            --parameters namePrefix=${{ github.event.inputs.namePrefix }} sqlAdminUser=karameladmin sqlAdminPassword=${{ secrets.SQL_ADMIN_PASSWORD }}

      - name: Ensure Key Vault secret exists
        id: kv
        run: |
          set -e
          KV_NAME="${{ github.event.inputs.namePrefix }}-kv"
          echo "KV_NAME=$KV_NAME" >> $GITHUB_OUTPUT
          # Generate strong secret if not provided
          if [ -z "${{ secrets.KARAMEL-TOKEN-SECRET }}" ]; then
            TOKEN_SECRET=$(openssl rand -base64 48)
            echo "Generated TOKEN_SECRET"
          else
            TOKEN_SECRET=${{ secrets.KARAMEL-TOKEN-SECRET }}
          fi
          az keyvault secret set --vault-name "$KV_NAME" --name "KARAMEL-TOKEN-SECRET" --value "$TOKEN_SECRET"

      - name: Assign Key Vault access to Web App (managed identity)
        run: |
          set -e
          RG=${{ github.event.inputs.rg }}
          PREFIX=${{ github.event.inputs.namePrefix }}
          WEBAPP_NAME="${PREFIX}-api"
          KV_NAME="${PREFIX}-kv"
          # Get principal id for the web app's system identity (requires identity to be enabled after web app creation)
          PRINCIPAL_ID=$(az webapp identity show --name $WEBAPP_NAME --resource-group $RG --query principalId -o tsv || true)
          if [ -z "$PRINCIPAL_ID" ]; then
            echo "Web App managed identity not enabled or not available yet. Skipping access grant."
          else
            az keyvault set-policy --name $KV_NAME --object-id $PRINCIPAL_ID --secret-permissions get list
            echo "Granted Key Vault access to web app identity"
          fi
